trigger:
  branches:
    include:
      - master

pool:
  name: boardgame-projecy

variables:
  MAVEN_OPTS: "-Dmaven.test.failure.ignore=true"

stages:
  - stage: Build_and_Test
    displayName: "Maven Build and Test"
    jobs:
      - job: MavenBuild
        displayName: "Compile and Run Unit Tests"
        steps:
          - task: Maven@4
            displayName: "Maven Compile & Test"
            inputs:
              azureSubscription: 'Azure subscription 1(5e47e5a1-7dc4-4abb-87a2-f371200842ea)'
              mavenPomFile: 'pom.xml'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              javaHomeOption: 'JDKVersion'
              mavenVersionOption: 'Default'
              mavenAuthenticateFeed: false
              effectivePomSkip: false
              sonarQubeRunAnalysis: false

  - stage: Dependency_Scan
    displayName: "Dependency Scan with Trivy"
    dependsOn: Build_and_Test
    jobs:
      - job: TrivyScan
        displayName: "Trivy Scan on pom.xml"
        steps:
          - script: |
              echo "Installing Trivy..."
              trivy fs --format table --severity MEDIUM,LOW,UNKNOWN,HIGH --exit-code 0 . && trivy fs --format table --severity CRITICAL --exit-code 0 .
            displayName: "Run Trivy on source code"

  - stage: Sonarqube_analusis
    displayName: "Dependency Scan with Trivy"
    jobs:
      - job: Sonarqube
        displayName: "Sonarqube_analysis"
        steps:
        - task: SonarQubePrepare@7
          inputs:
           SonarQube: 'sonarqube-svc'
           scannerMode: 'cli'
           cliScannerVersion: '7.0.1.4817'
           configMode: 'file'